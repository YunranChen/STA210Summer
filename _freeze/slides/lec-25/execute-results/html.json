{
  "hash": "fd57012bd5232d715c3c2b5c237faf55",
  "result": {
    "markdown": "---\ntitle: \"MultiLR: Predictive models\"\nsubtitle: \"STA 210 - Summer 2022\"\nauthor: \"Yunran Chen\"\nfooter:  \"[yunranchen.github.io/STA210Summer/](https://yunranchen.github.io/STA210Summer/)\"\nlogo: \"images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    transition: fade\n    slide-number: true\n    incremental: true \n    chalkboard: true\n    highlight-style: ayu-mirage\ncode-link: true\neditor: visual\nexecute:\n  freeze: auto\n  echo: true\n---\n\n\n\n\n# Welcome\n\n## Topics\n\n::: nonincremental\n-   Building predictive multinomial logistic regression models\n-   Comparing models\n-   Unbalanced data\n-   Choosing the \"final\" model\n:::\n\n## Computational setup\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# load packages\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(knitr)\nlibrary(colorblindr)\nlibrary(themis)\n\n# set default theme and larger font size for ggplot2\nggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))\n```\n:::\n\n\n## Terminology\n\n::: question\nWhat's the difference between regression and classification?\n::: nonincremental\n-   Logistic regression / binary classification\n-   Multinomial logistic regression / multinomial classification\n:::\n:::\n\n# Data\n\n## Volcanoes\n\nThe data come from [The Smithsonian Institution](https://volcano.si.edu/), via [TidyTuesday](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-12/readme.md).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano <- read_csv(here::here(\"slides\", \"data/volcano.csv\"))\nnames(volcano)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"volcano_number\"           \"volcano_name\"            \n [3] \"primary_volcano_type\"     \"last_eruption_year\"      \n [5] \"country\"                  \"region\"                  \n [7] \"subregion\"                \"latitude\"                \n [9] \"longitude\"                \"elevation\"               \n[11] \"tectonic_settings\"        \"evidence_category\"       \n[13] \"major_rock_1\"             \"major_rock_2\"            \n[15] \"major_rock_3\"             \"major_rock_4\"            \n[17] \"major_rock_5\"             \"minor_rock_1\"            \n[19] \"minor_rock_2\"             \"minor_rock_3\"            \n[21] \"minor_rock_4\"             \"minor_rock_5\"            \n[23] \"population_within_5_km\"   \"population_within_10_km\" \n[25] \"population_within_30_km\"  \"population_within_100_km\"\n```\n:::\n:::\n\n\n## Volcanoes {.smaller}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nglimpse(volcano)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 958\nColumns: 26\n$ volcano_number           <dbl> 283001, 355096, 342080, 213004, 321040, 28317…\n$ volcano_name             <chr> \"Abu\", \"Acamarachi\", \"Acatenango\", \"Acigol-Ne…\n$ primary_volcano_type     <chr> \"Shield(s)\", \"Stratovolcano\", \"Stratovolcano(…\n$ last_eruption_year       <chr> \"-6850\", \"Unknown\", \"1972\", \"-2080\", \"950\", \"…\n$ country                  <chr> \"Japan\", \"Chile\", \"Guatemala\", \"Turkey\", \"Uni…\n$ region                   <chr> \"Japan, Taiwan, Marianas\", \"South America\", \"…\n$ subregion                <chr> \"Honshu\", \"Northern Chile, Bolivia and Argent…\n$ latitude                 <dbl> 34.500, -23.292, 14.501, 38.537, 46.206, 37.6…\n$ longitude                <dbl> 131.600, -67.618, -90.876, 34.621, -121.490, …\n$ elevation                <dbl> 641, 6023, 3976, 1683, 3742, 1728, 1733, 1250…\n$ tectonic_settings        <chr> \"Subduction zone / Continental crust (>25 km)…\n$ evidence_category        <chr> \"Eruption Dated\", \"Evidence Credible\", \"Erupt…\n$ major_rock_1             <chr> \"Andesite / Basaltic Andesite\", \"Dacite\", \"An…\n$ major_rock_2             <chr> \"Basalt / Picro-Basalt\", \"Andesite / Basaltic…\n$ major_rock_3             <chr> \"Dacite\", \" \", \" \", \"Basalt / Picro-Basalt\", …\n$ major_rock_4             <chr> \" \", \" \", \" \", \"Andesite / Basaltic Andesite\"…\n$ major_rock_5             <chr> \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", …\n$ minor_rock_1             <chr> \" \", \" \", \"Basalt / Picro-Basalt\", \" \", \"Daci…\n$ minor_rock_2             <chr> \" \", \" \", \" \", \" \", \" \", \"Basalt / Picro-Basa…\n$ minor_rock_3             <chr> \" \", \" \", \" \", \" \", \" \", \" \", \" \", \"Andesite …\n$ minor_rock_4             <chr> \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", …\n$ minor_rock_5             <chr> \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", …\n$ population_within_5_km   <dbl> 3597, 0, 4329, 127863, 0, 428, 101, 51, 0, 98…\n$ population_within_10_km  <dbl> 9594, 7, 60730, 127863, 70, 3936, 485, 6042, …\n$ population_within_30_km  <dbl> 117805, 294, 1042836, 218469, 4019, 717078, 1…\n$ population_within_100_km <dbl> 4071152, 9092, 7634778, 2253483, 393303, 5024…\n```\n:::\n:::\n\n\n## Types of volcanoes {.smaller}\n\nProbably too many types!\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano %>%\n  count(primary_volcano_type, sort = TRUE) %>%\n  print(n = 26)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 26 × 2\n   primary_volcano_type     n\n   <chr>                <int>\n 1 Stratovolcano          353\n 2 Stratovolcano(es)      107\n 3 Shield                  85\n 4 Volcanic field          71\n 5 Pyroclastic cone(s)     70\n 6 Caldera                 65\n 7 Complex                 46\n 8 Shield(s)               33\n 9 Submarine               27\n10 Lava dome(s)            26\n11 Fissure vent(s)         12\n12 Caldera(s)               9\n13 Compound                 9\n14 Maar(s)                  8\n15 Pyroclastic shield       7\n16 Tuff cone(s)             7\n17 Crater rows              5\n18 Subglacial               5\n19 Pyroclastic cone         4\n20 Lava dome                3\n21 Complex(es)              1\n22 Lava cone                1\n23 Lava cone(es)            1\n24 Lava cone(s)             1\n25 Stratovolcano?           1\n26 Tuff cone                1\n```\n:::\n:::\n\n\n## Relevel volcanoes\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano <- volcano %>%\n  mutate(\n    volcano_type = case_when(\n      str_detect(primary_volcano_type, \"Stratovolcano\") ~ \"Stratovolcano\",\n      str_detect(primary_volcano_type, \"Shield\") ~ \"Shield\",\n      TRUE ~ \"Other\"\n    ),\n    volcano_type = fct_relevel(volcano_type, \"Stratovolcano\", \"Shield\", \"Other\")\n  )\n\nvolcano %>%\n  count(volcano_type)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 2\n  volcano_type      n\n  <fct>         <int>\n1 Stratovolcano   461\n2 Shield          118\n3 Other           379\n```\n:::\n:::\n\n\n## Data prep\n\n-   Select a few variables as predictors for the model with\n-   Convert all character variables to factors\n\n. . .\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano <- volcano %>%\n  select(\n    volcano_type, latitude, longitude, \n    elevation, tectonic_settings, major_rock_1\n    ) %>%\n  mutate(across(where(is.character), as_factor))\n```\n:::\n\n\n## Mapping the volcanoes\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-8-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## World map data\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nworld <- map_data(\"world\")\n\nworld %>% as_tibble()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 99,338 × 6\n    long   lat group order region subregion\n   <dbl> <dbl> <dbl> <int> <chr>  <chr>    \n 1 -69.9  12.5     1     1 Aruba  <NA>     \n 2 -69.9  12.4     1     2 Aruba  <NA>     \n 3 -69.9  12.4     1     3 Aruba  <NA>     \n 4 -70.0  12.5     1     4 Aruba  <NA>     \n 5 -70.1  12.5     1     5 Aruba  <NA>     \n 6 -70.1  12.6     1     6 Aruba  <NA>     \n 7 -70.0  12.6     1     7 Aruba  <NA>     \n 8 -70.0  12.6     1     8 Aruba  <NA>     \n 9 -69.9  12.5     1     9 Aruba  <NA>     \n10 -69.9  12.5     1    10 Aruba  <NA>     \n# … with 99,328 more rows\n```\n:::\n:::\n\n\n## Draw world map\n\n\n::: {.cell layout-align=\"center\" output-location='column-fragment'}\n\n```{.r .cell-code}\nworld_map <- ggplot() +\n  geom_polygon(\n    data = world, \n    aes(\n      x = long, y = lat, group = group),\n      color = \"white\", fill = \"gray50\", \n      size = 0.05, alpha = 0.2\n    ) +\n  theme_minimal() +\n  coord_quickmap() +\n  labs(x = NULL, y = NULL)\n\nworld_map\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-10-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## Add volcanoes\n\n\n::: {.cell layout-align=\"center\" output-location='column-fragment'}\n\n```{.r .cell-code}\nworld_map +\n  geom_point(\n    data = volcano,\n    aes(\n      x = longitude, y = latitude, \n      color = volcano_type, \n      shape = volcano_type),\n    alpha = 0.5\n  ) +\n  scale_color_OkabeIto() +\n  labs(color = NULL, shape = NULL)\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-11-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n\n# Build a model\n\n## Split into testing/training\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(1234)\n\nvolcano_split <- initial_split(volcano)\nvolcano_train <- training(volcano_split)\nvolcano_test  <- testing(volcano_split)\n```\n:::\n\n\n## Create a recipe\n\nStart with a model that doesn't use geographic information:\n\nstep_other creates a specification of a recipe step that will potentially pool infrequently occurring values into an \"other\" category.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|2|3,4|5|6|7\"}\nvolcano_rec1 <- recipe(volcano_type ~ ., data = volcano_train) %>%\n  step_rm(latitude, longitude) %>%\n  step_other(tectonic_settings) %>%\n  step_other(major_rock_1) %>%\n  step_dummy(all_nominal_predictors()) %>%\n  step_zv(all_predictors()) %>%\n  step_center(all_predictors())\n```\n:::\n\n\n## Specify a model\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_spec <- multinom_reg() %>%\n  set_engine(\"nnet\")\n\nvolcano_spec\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nMultinomial Regression Model Specification (classification)\n\nComputational engine: nnet \n```\n:::\n:::\n\n\n## Create a workflow\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|1|2|3\"}\nvolcano_wflow1 <- workflow() %>%\n  add_recipe(volcano_rec1) %>%\n  add_model(volcano_spec)\n\nvolcano_wflow1\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n══ Workflow ════════════════════════════════════════════════════════════════════\nPreprocessor: Recipe\nModel: multinom_reg()\n\n── Preprocessor ────────────────────────────────────────────────────────────────\n6 Recipe Steps\n\n• step_rm()\n• step_other()\n• step_other()\n• step_dummy()\n• step_zv()\n• step_center()\n\n── Model ───────────────────────────────────────────────────────────────────────\nMultinomial Regression Model Specification (classification)\n\nComputational engine: nnet \n```\n:::\n:::\n\n\n## Create cross validation folds\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(9876)\n\nvolcano_folds <- vfold_cv(volcano_train, v = 5)\nvolcano_folds\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#  5-fold cross-validation \n# A tibble: 5 × 2\n  splits            id   \n  <list>            <chr>\n1 <split [574/144]> Fold1\n2 <split [574/144]> Fold2\n3 <split [574/144]> Fold3\n4 <split [575/143]> Fold4\n5 <split [575/143]> Fold5\n```\n:::\n:::\n\n\n## Fit resamples\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|1|2-5\"}\nvolcano_fit_rs1 <- volcano_wflow1 %>%\n  fit_resamples(\n    volcano_folds, \n    control = control_resamples(save_pred = TRUE)\n    )\n\nvolcano_fit_rs1\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Resampling results\n# 5-fold cross-validation \n# A tibble: 5 × 5\n  splits            id    .metrics         .notes           .predictions      \n  <list>            <chr> <list>           <list>           <list>            \n1 <split [574/144]> Fold1 <tibble [2 × 4]> <tibble [0 × 3]> <tibble [144 × 7]>\n2 <split [574/144]> Fold2 <tibble [2 × 4]> <tibble [0 × 3]> <tibble [144 × 7]>\n3 <split [574/144]> Fold3 <tibble [2 × 4]> <tibble [0 × 3]> <tibble [144 × 7]>\n4 <split [575/143]> Fold4 <tibble [2 × 4]> <tibble [0 × 3]> <tibble [143 × 7]>\n5 <split [575/143]> Fold5 <tibble [2 × 4]> <tibble [0 × 3]> <tibble [143 × 7]>\n```\n:::\n:::\n\n\n## Collect metrics\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncollect_metrics(volcano_fit_rs1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 6\n  .metric  .estimator  mean     n std_err .config             \n  <chr>    <chr>      <dbl> <int>   <dbl> <chr>               \n1 accuracy multiclass 0.596     5  0.0146 Preprocessor1_Model1\n2 roc_auc  hand_till  0.703     5  0.0244 Preprocessor1_Model1\n```\n:::\n:::\n\n\n## ROC curve\n\nROC curves for multiclass outcomes use a one-vs-all approach: calculate multiple curves, one per level vs. all other levels.\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code}\nvolcano_fit_rs1 %>%\n  collect_predictions() %>%\n  group_by(id) %>%\n  roc_curve(\n    truth = volcano_type,\n    .pred_Stratovolcano:.pred_Other\n  ) %>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-19-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## ROC curve - under the hood\n\nAn additional column, `.level`, identifies the \"one\" column in the one-vs-all calculation:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_fit_rs1 %>%\n  collect_predictions() %>%\n  group_by(id) %>%\n  roc_curve(\n    truth = volcano_type,\n    .pred_Stratovolcano:.pred_Other\n  )%>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-20-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n# Unbalanced data\n\n## Unbalanced data {.smaller}\n\nRemember that the observed volcano types are unbalanced:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano %>% \n  count(volcano_type)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 2\n  volcano_type      n\n  <fct>         <int>\n1 Stratovolcano   461\n2 Shield          118\n3 Other           379\n```\n:::\n:::\n\nFor educational purpose, we consider some statistical tools to address this issue.\n\n## Addressing unbalance {.smaller}\n\n\nTo address class unbalance, we generally use\n\n-   **oversampling** data from levels that are less prevalent in the data\n    -   e.g., `step_smote()`: Uses a technique called [\"**S**ynthetic **M**inority **O**ver-sampling **Te**chnique\"](https://jair.org/index.php/jair/article/view/10302/24590) to generate new examples of the minority class using nearest neighbors of these cases.\n-   **downsampling** data from levels that are more prevalent in the data\n    -   e.g., `step_downsample()`: Removes rows of a data set to make the occurrence of levels in a specific factor level equal.\n\n## New recipe - oversample\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|7\"}\nvolcano_rec3 <- recipe(volcano_type ~ ., data = volcano_train) %>%\n  step_other(tectonic_settings) %>%\n  step_other(major_rock_1) %>%\n  step_dummy(all_nominal_predictors()) %>%\n  step_zv(all_predictors()) %>%\n  step_center(all_predictors()) %>%\n  step_smote(volcano_type)\n```\n:::\n\n\n## New recipe - downsample\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|7\"}\nvolcano_rec4 <- recipe(volcano_type ~ ., data = volcano_train) %>%\n  step_other(tectonic_settings) %>%\n  step_other(major_rock_1) %>%\n  step_dummy(all_nominal_predictors()) %>%\n  step_zv(all_predictors()) %>%\n  step_center(all_predictors()) %>%\n  step_downsample(volcano_type)\n```\n:::\n\n\n## New workflows\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_wflow3 <- workflow() %>%\n  add_recipe(volcano_rec3) %>%\n  add_model(volcano_spec)\n\nvolcano_wflow4 <- workflow() %>%\n  add_recipe(volcano_rec4) %>%\n  add_model(volcano_spec)\n```\n:::\n\n\n## Fit resamples\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_fit_rs3 <- volcano_wflow3 %>%\n  fit_resamples(\n    volcano_folds, \n    control = control_resamples(save_pred = TRUE)\n    )\n\nvolcano_fit_rs4 <- volcano_wflow4 %>%\n  fit_resamples(\n    volcano_folds, \n    control = control_resamples(save_pred = TRUE)\n    )\n```\n:::\n\n\n## Collect metrics\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncollect_metrics(volcano_fit_rs3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 6\n  .metric  .estimator  mean     n std_err .config             \n  <chr>    <chr>      <dbl> <int>   <dbl> <chr>               \n1 accuracy multiclass 0.510     5  0.0169 Preprocessor1_Model1\n2 roc_auc  hand_till  0.693     5  0.0243 Preprocessor1_Model1\n```\n:::\n\n```{.r .cell-code}\ncollect_metrics(volcano_fit_rs4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 6\n  .metric  .estimator  mean     n std_err .config             \n  <chr>    <chr>      <dbl> <int>   <dbl> <chr>               \n1 accuracy multiclass 0.504     5  0.0264 Preprocessor1_Model1\n2 roc_auc  hand_till  0.669     5  0.0147 Preprocessor1_Model1\n```\n:::\n:::\n\n\n## ROC curves - oversampling\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_fit_rs3 %>%\n  collect_predictions() %>%\n  group_by(id) %>%\n  roc_curve(\n    truth = volcano_type,\n    .pred_Stratovolcano:.pred_Other\n  ) %>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-27-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## ROC curves - downsampling\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_fit_rs4 %>%\n  collect_predictions() %>%\n  group_by(id) %>%\n  roc_curve(\n    truth = volcano_type,\n    .pred_Stratovolcano:.pred_Other\n  ) %>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-28-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## Addressing unbalance\n\n::: question\nCan you think of any issues resulting from over/down sampling?\n:::\n\n# Final model\n\n## The \"chosen\" model\n\nLet's stick to the models without over/down sampling.\n\nFrom the application exercise:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_rec2 <- recipe(volcano_type ~ ., data = volcano_train) %>%\n  step_other(tectonic_settings) %>%\n  step_other(major_rock_1) %>%\n  step_dummy(all_nominal_predictors()) %>%\n  step_zv(all_predictors()) %>%\n  step_center(all_predictors())\n\nvolcano_wflow2 <- workflow() %>%\n  add_recipe(volcano_rec2) %>%\n  add_model(volcano_spec)\n```\n:::\n\n\n## Fitting the final model\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|1-4|6\"}\nfinal_fit <- last_fit(\n  volcano_wflow2, \n  split = volcano_split\n  )\n\ncollect_metrics(final_fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 4\n  .metric  .estimator .estimate .config             \n  <chr>    <chr>          <dbl> <chr>               \n1 accuracy multiclass     0.629 Preprocessor1_Model1\n2 roc_auc  hand_till      0.734 Preprocessor1_Model1\n```\n:::\n:::\n\n\n## Confusion matrix\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncollect_predictions(final_fit) %>%\n  conf_mat(volcano_type, .pred_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               Truth\nPrediction      Stratovolcano Shield Other\n  Stratovolcano            96     13    38\n  Shield                    1      0     0\n  Other                    21     16    55\n```\n:::\n:::\n\n\n## Confusion matrix - visualized\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncollect_predictions(final_fit) %>%\n  conf_mat(volcano_type, .pred_class) %>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-32-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## ROC curve\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncollect_predictions(final_fit) %>%\n  roc_curve(truth = volcano_type, .pred_Stratovolcano:.pred_Other) %>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-33-1.png){fig-align='center' width=90%}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-34-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## Prediction\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfinal_fitted <- extract_workflow(final_fit)\n\nnew_volcano <- tibble(\n  latitude = 35.9940,\n  longitude = -78.8986,\n  elevation = 404,\n  tectonic_settings = \"Subduction zone / Continental crust (>25 km)\",\n  major_rock_1 = \"Andesite / Basaltic Andesite\"\n)\n\npredict(\n  final_fitted, \n  new_volcano, \n  type = \"prob\"\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 3\n  .pred_Stratovolcano .pred_Shield .pred_Other\n                <dbl>        <dbl>       <dbl>\n1               0.381       0.0379       0.581\n```\n:::\n:::\n\n\n\n\n## Acknowledgements\n\nInspired by\n\n::: nonincremental\n-   https://juliasilge.com/blog/multinomial-volcano-eruptions/\n-   https://juliasilge.com/blog/nber-papers/\n:::\n",
    "supporting": [
      "lec-25_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    function fireSlideChanged(previousSlide, currentSlide) {\n\n      // dispatch for htmlwidgets\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for reveal\n    if (window.Reveal) {\n      window.Reveal.addEventListener(\"slidechanged\", function(event) {\n        fireSlideChanged(event.previousSlide, event.currentSlide);\n      });\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}