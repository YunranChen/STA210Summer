{"title":"MultiLR: Predictive models","markdown":{"yaml":{"title":"MultiLR: Predictive models","subtitle":"STA 210 - Spring 2022","author":"Dr. Mine Ã‡etinkaya-Rundel","footer":"[sta210-s22.github.io/website](https://sta210-s22.github.io/website/)","logo":"images/logo.png","format":{"revealjs":{"theme":"slides.scss","transition":"fade","slide-number":true,"incremental":true,"chalkboard":true,"highlight-style":"ayu-mirage"}},"code-link":true,"editor":"visual","execute":{"freeze":"auto","echo":true}},"headingText":"| include: false","containsRefs":false,"markdown":"\n\n```{r}\n\n# figure options\nknitr::opts_chunk$set(\n  fig.width = 8, fig.asp = 0.618, out.width = \"90%\",\n  fig.retina = 3, dpi = 300, fig.align = \"center\"\n)\n\nlibrary(countdown)\n```\n\n# Welcome\n\n## Topics\n\n::: nonincremental\n-   Building predictive multinomial logistic regression models\n-   Comparing models\n:::\n\n## Computational setup\n\n```{r}\n#| echo: true\n\n# load packages\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(knitr)\nlibrary(colorblindr)\nlibrary(themis)\n\n# set default theme and larger font size for ggplot2\nggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))\n```\n\n## Terminology\n\n::: question\nWhat's the difference between regression and classification?\n\n::: nonincremental\n-   Logistic regression / binary classification\n-   Multinomial logistic regression / multinomial classification\n:::\n:::\n\n# Data\n\n## Volcanoes\n\nThe data come from [The Smithsonian Institution](https://volcano.si.edu/), via [TidyTuesday](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-12/readme.md).\n\n```{r}\n#| warning: false\n\nvolcano <- read_csv(here::here(\"slides\", \"data/volcano.csv\"))\nnames(volcano)\n```\n\n## Volcanoes {.smaller}\n\n```{r}\nglimpse(volcano)\n```\n\n## Types of volcanoes {.smaller}\n\nProbably too many types!\n\n```{r}\nvolcano %>%\n  count(primary_volcano_type, sort = TRUE) %>%\n  print(n = 26)\n```\n\n## Relevel volcanoes\n\n```{r}\nvolcano <- volcano %>%\n  mutate(\n    volcano_type = case_when(\n      str_detect(primary_volcano_type, \"Stratovolcano\") ~ \"Stratovolcano\",\n      str_detect(primary_volcano_type, \"Shield\") ~ \"Shield\",\n      TRUE ~ \"Other\"\n    ),\n    volcano_type = fct_relevel(volcano_type, \"Stratovolcano\", \"Shield\", \"Other\")\n  )\n\nvolcano %>%\n  count(volcano_type)\n```\n\n## Data prep\n\n-   Select a few variables as predictors for the model with\n-   Convert all character variables to factors\n\n. . .\n\n```{r}\nvolcano <- volcano %>%\n  select(\n    volcano_type, latitude, longitude, \n    elevation, tectonic_settings, major_rock_1\n    ) %>%\n  mutate(across(where(is.character), as_factor))\n```\n\n## Mapping the volcanoes\n\n```{r}\n#| echo: false\n\nworld <- map_data(\"world\")\n\nggplot() +\n  geom_polygon(\n    data = world, \n    aes(x = long, y = lat, group = group),\n    color = \"white\", fill = \"gray50\", size = 0.05, alpha = 0.2\n  ) +\n  geom_point(\n    data = volcano,\n    aes(x = longitude, y = latitude, \n        color = volcano_type, shape = volcano_type),\n    alpha = 0.8\n  ) +\n  scale_color_OkabeIto() +\n  theme_minimal() +\n  coord_quickmap() +\n  labs(x = NULL, y = NULL, color = NULL, shape = NULL)\n```\n\n## World map data\n\n```{r}\nworld <- map_data(\"world\")\n\nworld %>% as_tibble()\n```\n\n## Draw world map\n\n```{r}\n#| output-location: column-fragment\n\nworld_map <- ggplot() +\n  geom_polygon(\n    data = world, \n    aes(\n      x = long, y = lat, group = group),\n      color = \"white\", fill = \"gray50\", \n      size = 0.05, alpha = 0.2\n    ) +\n  theme_minimal() +\n  coord_quickmap() +\n  labs(x = NULL, y = NULL)\n\nworld_map\n```\n\n## Add volcanoes\n\n```{r}\n#| output-location: column-fragment\n\nworld_map +\n  geom_point(\n    data = volcano,\n    aes(\n      x = longitude, y = latitude, \n      color = volcano_type, \n      shape = volcano_type),\n    alpha = 0.5\n  ) +\n  scale_color_OkabeIto() +\n  labs(color = NULL, shape = NULL)\n```\n\n## Your turn\n\n::: appex\nðŸ“‹ [github.com/sta210-s22/ae-11-volcanoes](https://github.com/sta210-s22/ae-11-volcanoes) - Exercise 1\n:::\n\n# Build a model\n\n## Split into testing/training\n\n```{r}\nset.seed(1234)\n\nvolcano_split <- initial_split(volcano)\nvolcano_train <- training(volcano_split)\nvolcano_test  <- testing(volcano_split)\n```\n\n## Create a recipe\n\nStart with a model that doesn't use geographic information:\n\n```{r}\n#| code-line-numbers: \"|2|3,4|5|6|7\"\n\nvolcano_rec1 <- recipe(volcano_type ~ ., data = volcano_train) %>%\n  step_rm(latitude, longitude) %>%\n  step_other(tectonic_settings) %>%\n  step_other(major_rock_1) %>%\n  step_dummy(all_nominal_predictors()) %>%\n  step_zv(all_predictors()) %>%\n  step_center(all_predictors())\n```\n\n## Specify a model\n\n```{r}\nvolcano_spec <- multinom_reg() %>%\n  set_engine(\"nnet\")\n\nvolcano_spec\n```\n\n## Create a workflow\n\n```{r}\n#| code-line-numbers: \"|1|2|3\"\n\nvolcano_wflow1 <- workflow() %>%\n  add_recipe(volcano_rec1) %>%\n  add_model(volcano_spec)\n\nvolcano_wflow1\n```\n\n## Create cross validation folds\n\n```{r}\nset.seed(9876)\n\nvolcano_folds <- vfold_cv(volcano_train, v = 5)\nvolcano_folds\n```\n\n## Fit resamples\n\n```{r}\n#| code-line-numbers: \"|1|2-5\"\n\nvolcano_fit_rs1 <- volcano_wflow1 %>%\n  fit_resamples(\n    volcano_folds, \n    control = control_resamples(save_pred = TRUE)\n    )\n\nvolcano_fit_rs1\n```\n\n## Collect metrics\n\n```{r}\ncollect_metrics(volcano_fit_rs1)\n```\n\n## ROC curve\n\nROC curves for multiclass outcomes use a one-vs-all approach: calculate multiple curves, one per level vs. all other levels.\n\n```{r}\n#| output-location: slide\n\nvolcano_fit_rs1 %>%\n  collect_predictions() %>%\n  group_by(id) %>%\n  roc_curve(\n    truth = volcano_type,\n    .pred_Stratovolcano:.pred_Other\n  ) %>%\n  autoplot()\n```\n\n## ROC curve - under the hood\n\nAn additional column, `.level`, identifies the \"one\" column in the one-vs-all calculation:\n\n```{r}\nvolcano_fit_rs1 %>%\n  collect_predictions() %>%\n  group_by(id) %>%\n  roc_curve(\n    truth = volcano_type,\n    .pred_Stratovolcano:.pred_Other\n  )\n```\n\n# Build another model\n\n## Your turn\n\n::: appex\nðŸ“‹ [github.com/sta210-s22/ae-11-volcanoes](https://github.com/sta210-s22/ae-11-volcanoes) - Exercise 2\n:::\n\n## Acknowledgements\n\nInspired by\n\n::: nonincremental\n-   https://juliasilge.com/blog/multinomial-volcano-eruptions/\n-   https://juliasilge.com/blog/nber-papers/\n:::\n"},"formats":{"revealjs":{"execute":{"fig-width":10,"fig-height":5,"fig-format":"retina","fig-dpi":96,"error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":true,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","html-math-method":{"method":"mathjax","url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML-full"},"slide-level":2,"to":"revealjs","incremental":true,"highlight-style":"ayu-mirage","output-file":"lec-25.html"},"language":{},"metadata":{"lang":"en","fig-responsive":false,"quarto-version":"0.9.345","auto-stretch":true,"editor":"visual","title":"MultiLR: Predictive models","subtitle":"STA 210 - Spring 2022","author":"Dr. Mine Ã‡etinkaya-Rundel","footer":"[sta210-s22.github.io/website](https://sta210-s22.github.io/website/)","logo":"images/logo.png","theme":"slides.scss","transition":"fade","slideNumber":true,"chalkboard":true}}}}